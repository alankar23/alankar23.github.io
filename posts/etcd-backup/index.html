<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Kubernetes Disaster Recovery: Guide to etcd Backup" /><meta name="author" content="Alankar Nimgade" /><meta property="og:locale" content="en" /><meta name="description" content="Kubernetes Etcd Backup" /><meta property="og:description" content="Kubernetes Etcd Backup" /><link rel="canonical" href="https://alankar23.github.io/posts/etcd-backup/" /><meta property="og:url" content="https://alankar23.github.io/posts/etcd-backup/" /><meta property="og:site_name" content="Alankar Nimgade" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-15T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kubernetes Disaster Recovery: Guide to etcd Backup" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Alankar Nimgade" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alankar Nimgade","url":"http://alankar23.github.io/about"},"dateModified":"2024-11-15T00:00:00+00:00","datePublished":"2024-11-15T00:00:00+00:00","description":"Kubernetes Etcd Backup","headline":"Kubernetes Disaster Recovery: Guide to etcd Backup","mainEntityOfPage":{"@type":"WebPage","@id":"https://alankar23.github.io/posts/etcd-backup/"},"url":"https://alankar23.github.io/posts/etcd-backup/"}</script><title>Kubernetes Disaster Recovery: Guide to etcd Backup | Alankar Nimgade</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Alankar Nimgade"><meta name="application-name" content="Alankar Nimgade"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/profile/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Alankar Nimgade</a></div><div class="site-subtitle font-italic">Mastering Code and Deployment, Unifying Development Artistry with DevOps Ingenuity</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/alankar23" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alankar','duck.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Kubernetes Disaster Recovery: Guide to etcd Backup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Kubernetes Disaster Recovery: Guide to etcd Backup</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 class="dynamic-title"> Kubernetes Disaster Recovery: Guide to etcd Backup</h1><div class="post-content"><h1 id="kubernetes-etcd-backup">Kubernetes Etcd Backup</h1><p>Ever wondered what happens when your Kubernetes cluster has a bad day? Let‚Äôs talk about backing up one of its most critical components - etcd, your cluster‚Äôs ‚Äúsource of truth.‚Äù</p><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Kubernetes (K8s) is like a conductor orchestrating a complex symphony of containers. Behind this orchestration lies etcd, a distributed key-value store that maintains the entire state of your cluster. Think of etcd as Kubernetes‚Äô memory bank - it stores everything from your pod configurations to your secrets. Lose etcd, and you‚Äôre essentially losing your cluster‚Äôs brain!</p><h2 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before we dive into the backup process, make sure you have:</p><ul><li>Kubernetes cluster (well duh)<li>Docker installed on your backup system<li>Access to the Kubernetes control plane (master node)<li><del>A cup</del> Multiple cups of chai (optional but recommended ‚òï)</ul><p>Pro tip: While these are the minimum requirements, it‚Äôs always good practice to test your backup strategy on a development cluster first.</p><h2 id="understanding-etcd"><span class="mr-2">Understanding etcd</span><a href="#understanding-etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="authentication-the-certificates-youll-need"><span class="mr-2">Authentication: The Certificates You‚Äôll Need</span><a href="#authentication-the-certificates-youll-need" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Security first! To interact with etcd, you‚Äôll need these certificates:</p><ul><li><code class="language-plaintext highlighter-rouge">/etc/kubernetes/pki/etcd/ca.crt</code>: The etcd CA certificate<li><code class="language-plaintext highlighter-rouge">/etc/kubernetes/pki/etcd/server.crt</code>: Server certificate<li><code class="language-plaintext highlighter-rouge">/etc/kubernetes/pki/etcd/server.key</code>: Server key</ul><p>These certs are your pass to etcd. Without them, you‚Äôre not getting in!</p><p>üí° <strong>Extra Tips Worth Knowing:</strong></p><ul><li>Store your backup certificates separately from your cluster<li>Regular backup testing is as important as the backup itself<li>Consider using automated backup solutions for production environments<li>Keep track of your etcd version - it matters for restore operations</ul><p>Remember: A backup is only as good as its latest test restore!</p><h2 id="how-to-back-up-etcd"><span class="mr-2">How to Back Up etcd</span><a href="#how-to-back-up-etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="cluster-etcd-information"><span class="mr-2">Cluster etcd Information</span><a href="#cluster-etcd-information" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To back up etcd, you‚Äôll need the etcd version and the necessary certificates. Start by retrieving the details of your etcd pod:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl describe pods <span class="nt">-n</span> kube-system etcd-k8s-master

Name:                 etcd-k8s-master                                                                                                                                                                               
Namespace:            kube-system  
Priority:             2000001000   
Priority Class Name:  system-node-critical
Node:                 k8s-master/192.168.100.10
Start Time:           Fri, 01 Nov 2024 01:38:00 +0530     
Labels:               <span class="nv">component</span><span class="o">=</span>etcd                                                                      
                      <span class="nv">tier</span><span class="o">=</span>control-plane                                                                  
Annotations:          kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.100.10:2379
                      kubernetes.io/config.hash: 0a0430dc440a1ab0ac89aac4cefec68c
                      kubernetes.io/config.mirror: 0a0430dc440a1ab0ac89aac4cefec68c
                      kubernetes.io/config.seen: 2024-09-07T10:46:31.843036711+05:30
                      kubernetes.io/config.source: file         
Status:               Running                       
IP:                   192.168.100.10                                                                     
IPs:                                             
  IP:           192.168.100.10                                                                           
Controlled By:  Node/k8s-master
Containers:                                                                                               
  etcd:                                
    Container ID:  containerd://2e02f2cbadcd4084acbd34374d397a94df6bfe0af9e4c8532e741320880e0b6d          
    Image:         registry.k8s.io/etcd:3.5.12-0                                                          
    Image ID:      registry.k8s.io/etcd@sha256:44a8e24dcbba3470ee1fee21d5e88d128c936e9b55d4bc51fbef8086f8ed123b                                                                                                      
    Port:          &lt;none&gt;                                                                                 
    Host Port:     &lt;none&gt;          
    Command:                                       
      etcd                         
      <span class="nt">--advertise-client-urls</span><span class="o">=</span>https://192.168.100.10:2379                                                
      <span class="nt">--cert-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/server.crt                                                     
      <span class="nt">--client-cert-auth</span><span class="o">=</span><span class="nb">true</span>                                                                             
      <span class="nt">--data-dir</span><span class="o">=</span>/var/lib/etcd                     
      <span class="nt">--experimental-initial-corrupt-check</span><span class="o">=</span><span class="nb">true</span>
      <span class="nt">--experimental-watch-progress-notify-interval</span><span class="o">=</span>5s                                                    
      <span class="nt">--initial-advertise-peer-urls</span><span class="o">=</span>https://192.168.100.10:2380
      <span class="nt">--initial-cluster</span><span class="o">=</span>k8s-master<span class="o">=</span>https://192.168.100.10:2380
      <span class="nt">--key-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/server.key
      <span class="nt">--listen-client-urls</span><span class="o">=</span>https://127.0.0.1:2379,https://192.168.100.10:2379
      <span class="nt">--listen-metrics-urls</span><span class="o">=</span>http://127.0.0.1:2381
      <span class="nt">--listen-peer-urls</span><span class="o">=</span>https://192.168.100.10:2380 
      <span class="nt">--name</span><span class="o">=</span>k8s-master
      <span class="nt">--peer-cert-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/peer.crt
      <span class="nt">--peer-client-cert-auth</span><span class="o">=</span><span class="nb">true</span>
      <span class="nt">--peer-key-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/peer.key
      <span class="nt">--peer-trusted-ca-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt
      <span class="nt">--snapshot-count</span><span class="o">=</span>10000
      <span class="nt">--trusted-ca-file</span><span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt
    Mounts:
      /etc/kubernetes/pki/etcd from etcd-certs <span class="o">(</span>rw<span class="o">)</span>
      /var/lib/etcd from etcd-data <span class="o">(</span>rw<span class="o">)</span>
Volumes:
  etcd-certs:
    Type:          HostPath <span class="o">(</span>bare host directory volume<span class="o">)</span>
    Path:          /etc/kubernetes/pki/etcd
    HostPathType:  DirectoryOrCreate
  etcd-data:
    Type:          HostPath <span class="o">(</span>bare host directory volume<span class="o">)</span>
    Path:          /var/lib/etcd
    HostPathType:  DirectoryOrCreate
</pre></table></code></div></div><h3 id="etcd-version"><span class="mr-2">etcd Version:</span><a href="#etcd-version" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The etcd version can be found in the image tag of the pod:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Image:registry.k8s.io/etcd:3.5.12-0 ### Certificates: Ensure you have the correct certificate paths to access etcd securely:

--cert-file=/etc/kubernetes/pki/etcd/server.crt
--key-file=/etc/kubernetes/pki/etcd/server.key                                           
--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt ### Certificate Host Location:
</pre></table></code></div></div><p>The certificate files are mounted from the host to the pod, as seen in the <code class="language-plaintext highlighter-rouge">Volumes</code> section</p><p>Volumes: etcd-certs: Type: HostPath (bare host directory volume) Path: /etc/kubernetes/pki/etcd HostPathType: DirectoryOrCreate</p><h3 id="prep"><span class="mr-2"><strong>Prep</strong></span><a href="#prep" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To start, we need to copy the certificates from the master node‚Äôs directory <code class="language-plaintext highlighter-rouge">/etc/kubernetes/pki/etcd/</code> to your local machine‚Äôs <code class="language-plaintext highlighter-rouge">etcd/certs</code> directory for authentication with etcd.</p><p>Example of the file structure in the <code class="language-plaintext highlighter-rouge">etcd/certs</code> directory:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> etcd/certs
<span class="nt">-rwxrwxrwx</span> 1 user user 1 KiB Sun Nov 3 14:49:02 2024 ca.crt
<span class="nt">-rwxrwxrwx</span> 1 user user 1 KiB Sun Nov 3 14:49:02 2024 server.crt
<span class="nt">-rwxrwxrwx</span> 1 user user 1 KiB Sun Nov 3 14:49:02 2024 server.key
</pre></table></code></div></div><p>Next, we‚Äôll use Docker to run the etcd container, and set up a cron job to regularly execute the container and capture a snapshot of the etcd data.</p><h3 id="dockerfile"><span class="mr-2"><strong>Dockerfile</strong></span><a href="#dockerfile" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="why-run-etcd-in-a-docker-container"><span class="mr-2"><strong>Why Run etcd in a Docker Container?</strong></span><a href="#why-run-etcd-in-a-docker-container" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Running the etcd backup container in Docker offers flexibility for future upgrades. If we decide to upgrade our cluster (including etcd) to a newer version, we‚Äôll also need to upgrade the etcd backup system. Instead of manually managing version updates, we can simply update the image tag in our Docker Compose file, making the process much easier.</p><h4 id="our-dockerfile"><span class="mr-2"><strong>Our Dockerfile</strong></span><a href="#our-dockerfile" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">etcd</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">bitnami/etcd:3.5.12</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ETCDCTL_API</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">etcdctl"</span><span class="pi">,</span><span class="s2">"</span><span class="s">--endpoints"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">https://192.168.100.10:2379"</span><span class="pi">,</span>   <span class="s2">"</span><span class="s">--cacert=/certs/ca.crt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--cert=/certs/server.crt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--key=/certs/server.key"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">snapshot"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">save"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/backup/snapshot.db"</span><span class="pi">]</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./etcd/certs:/certs</span>
      <span class="pi">-</span> <span class="s">./backup:/backup</span>
</pre></table></code></div></div><p>In this setup, we‚Äôve mounted the necessary certificates and the backup directory into the container. We use the <code class="language-plaintext highlighter-rouge">etcdctl snapshot save</code> command to create the snapshot backup.</p><h4 id="running-the-container"><span class="mr-2"><strong>Running the Container</strong></span><a href="#running-the-container" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>When we run the container using Docker Compose, we should see the following output:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker compose up  
<span class="o">[</span>+] Running 2/0
 ‚†ø Network etcd-backup_default   Created                                                                                                      0.0s  
 ‚†ø Container etcd-backup-etcd-1  Created                                                                                                      0.0s
Attaching to etcd-backup-etcd-1
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:19:48.879484Z"</span>,<span class="s2">"caller"</span>:<span class="s2">"snapshot/v3_snapshot.go:65"</span>,<span class="s2">"msg"</span>:<span class="s2">"created temporary db file"</span>,<span class="s2">"path"</span>:<span class="s2">"/backup/snapshot.db.part"</span><span class="o">}</span>
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:19:49.029314Z"</span>,<span class="s2">"logger"</span>:<span class="s2">"client"</span>,<span class="s2">"caller"</span>:<span class="s2">"v3@v3.5.12/maintenance.go:212"</span>,<span class="s2">"msg"</span>:<span class="s2">"opened snapshot stream; downloading"</span><span class="o">}</span>
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:19:49.029366Z"</span>,<span class="s2">"caller"</span>:<span class="s2">"snapshot/v3_snapshot.go:73"</span>,<span class="s2">"msg"</span>:<span class="s2">"fetching snapshot"</span>,<span class="s2">"endpoint"</span>:<span class="s2">"https://192.168.100.10:2379"</span><span class="o">}</span>
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:20:13.297681Z"</span>,<span class="s2">"logger"</span>:<span class="s2">"client"</span>,<span class="s2">"caller"</span>:<span class="s2">"v3@v3.5.12/maintenance.go:220"</span>,<span class="s2">"msg"</span>:<span class="s2">"completed snapshot read; closing"</span><span class="o">}</span>
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:20:13.355176Z"</span>,<span class="s2">"caller"</span>:<span class="s2">"snapshot/v3_snapshot.go:88"</span>,<span class="s2">"msg"</span>:<span class="s2">"fetched snapshot"</span>,<span class="s2">"endpoint"</span>:<span class="s2">"https://192.168.100.10:2379"</span>,<span class="s2">"size"</span>:<span class="s2">"49 MB"</span>,<span class="s2">"took"</span>:<span class="s2">"24 seconds ago"</span><span class="o">}</span>
etcd-backup-etcd-1  | <span class="o">{</span><span class="s2">"level"</span>:<span class="s2">"info"</span>,<span class="s2">"ts"</span>:<span class="s2">"2024-11-15T08:20:13.355275Z"</span>,<span class="s2">"caller"</span>:<span class="s2">"snapshot/v3_snapshot.go:97"</span>,<span class="s2">"msg"</span>:<span class="s2">"saved"</span>,<span class="s2">"path"</span>:<span class="s2">"/backup/snapshot.db"</span><span class="o">}</span>
etcd-backup-etcd-1  | Snapshot saved at /backup/snapshot.db
</pre></table></code></div></div><p>And voil√†! Our etcd backup container is now up and running, successfully saving the snapshot.</p><h3 id="automating-the-backup"><span class="mr-2"><strong>Automating the Backup</strong></span><a href="#automating-the-backup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="shell-script"><span class="mr-2"><strong>Shell Script</strong></span><a href="#shell-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Create the backup shell script (<code class="language-plaintext highlighter-rouge">etcd.sh</code>), which will run the Docker Compose command and compress each snapshot file with a date and time stamp to reduce its size:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>etcd.sh

<span class="c">#!/bin/bash</span>

<span class="c"># Change this to your project directory</span>
<span class="nb">cd</span> /home/alankar/etcd-backup

docker compose up 

<span class="c"># Define source and destination directories</span>
<span class="nv">SOURCE_DIR</span><span class="o">=</span><span class="s2">"backup/snapshot.db"</span>
<span class="nv">DEST_alankar</span><span class="o">=</span><span class="s2">"backup"</span> 

<span class="c"># Get the current time for the zip file name and today's date for the directory name</span>
<span class="nv">CURRENT_TIME</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +<span class="s2">"%H-%M"</span><span class="si">)</span>
<span class="nv">TODAY_DATE</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +<span class="s2">"%d-%m"</span><span class="si">)</span>


<span class="c"># Define the zip file name and the destination directory path</span>
<span class="nv">ZIP_NAME</span><span class="o">=</span><span class="s2">"etcd-</span><span class="nv">$CURRENT_TIME</span><span class="s2">.zip"</span>
<span class="nv">DEST_DIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$DEST_alankar</span><span class="s2">/</span><span class="nv">$TODAY_DATE</span><span class="s2">"</span>

<span class="c"># Create the destination directory if it doesn't exist</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$DEST_DIR</span><span class="s2">"</span>

<span class="c"># Create the zip file</span>
zip <span class="nt">-r</span> <span class="s2">"</span><span class="nv">$DEST_DIR</span><span class="s2">/</span><span class="nv">$ZIP_NAME</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$SOURCE_DIR</span><span class="s2">"</span>

<span class="c"># Output the result</span>
<span class="nb">echo</span> <span class="s2">"Created zip file: </span><span class="nv">$DEST_DIR</span><span class="s2">/</span><span class="nv">$ZIP_NAME</span><span class="s2">"</span>
</pre></table></code></div></div><p>Basically this script runs the Docker Compose backup and then compresses the resulting snapshot file, saving it with a timestamp to help organize backups.</p><h4 id="crontab"><span class="mr-2"><strong>Crontab</strong></span><a href="#crontab" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We‚Äôll now schedule this script to run every 12 hours using <strong>crontab</strong>. This way, backups will be taken automatically without manual intervention.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>crontab <span class="nt">-l</span>
0 <span class="k">*</span>/12 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /home/alankar/etcd-backup/etcd.sh <span class="o">&gt;</span>/home/alankar/etcd-backup/etcd.log 
</pre></table></code></div></div><p>We are running our script at every 12 th our of the day and spitting the output in <code class="language-plaintext highlighter-rouge">etcd.log</code></p><h4 id="checking-the-backup-output"><span class="mr-2"><strong>Checking the Backup Output</strong></span><a href="#checking-the-backup-output" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You can check the log file (<code class="language-plaintext highlighter-rouge">etcd.log</code>) to see the backup process in action:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>etcd.log 
Run Time is 12-00
Attaching to etcd-etcd-1
etcd-etcd-1  | Snapshot saved at /backup/snapshot.db
etcd-etcd-1 exited with code 0
  adding: backup/snapshot.db <span class="o">(</span>deflated 69%<span class="o">)</span>
Created zip file: backup/15-11/etcd-12-00.zip
</pre></table></code></div></div><p>You can also verify the backups in the <code class="language-plaintext highlighter-rouge">backup</code> directory:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>  backup/
drwxr-xr-x 2 alankar alankar     4096 Nov 15 12:00 15-11
<span class="nt">-rw-------</span> 1 alankar alankar 48611360 Nov 15 12:00 snapshot.db
<span class="nv">$ </span> <span class="nb">ls</span> <span class="nt">-l</span>  backup/15-11/
total 29024
<span class="nt">-rw-r--r--</span> 1 alankar alankar 14872336 Nov 15 00:00 etcd-00-00.zip
<span class="nt">-rw-r--r--</span> 1 alankar alankar 14847133 Nov 15 12:00 etcd-12-00.zip
</pre></table></code></div></div><h3 id="restoring-etcd"><span class="mr-2"><strong>Restoring etcd</strong></span><a href="#restoring-etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To restore an etcd snapshot:</p><ol><li><p><strong>Extract the Snapshot</strong>:<br /> Decompress the zip file to retrieve the <code class="language-plaintext highlighter-rouge">snapshot.db</code>.</p><li><p><strong>Use the Compose File</strong>:<br /> In the restore folder, you‚Äôll find a <code class="language-plaintext highlighter-rouge">member</code> directory, which you‚Äôll need to copy to your master node.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre> <span class="na">services</span><span class="pi">:</span>
   <span class="na">etcd</span><span class="pi">:</span>
     <span class="na">image</span><span class="pi">:</span> <span class="s">bitnami/etcd:3.5.12</span>
     <span class="na">environment</span><span class="pi">:</span>
       <span class="na">ETCDCTL_API</span><span class="pi">:</span> <span class="m">3</span>
     <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">etcdctl"</span><span class="pi">,</span><span class="s2">"</span><span class="s">--data-dir"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/restore/"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">snapshot"</span><span class="pi">,</span><span class="s2">"</span><span class="s">restore"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/backup/snapshot.db"</span><span class="pi">]</span>
     <span class="na">volumes</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s">./backup:/backup</span>
       <span class="pi">-</span> <span class="s">./restore:/restore</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="nv">$ </span><span class="nb">ls </span>restore/
  member
</pre></table></code></div></div><p>Copy the member directory to your master nod.</p><li><p><strong>Update the <code class="language-plaintext highlighter-rouge">etcd.yaml</code> Static Pod</strong>:<br /> Copy the member directory to your master node and edit the <code class="language-plaintext highlighter-rouge">etcd.yaml</code> static pod at <code class="language-plaintext highlighter-rouge">/etc/kubernetes/manifests</code></p><p>Change this path to</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="pi">-</span> <span class="na">hostPath</span><span class="pi">:</span>
     <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/etcd</span>
     <span class="na">type</span><span class="pi">:</span> <span class="s">DirectoryOrCreate</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-data</span>
</pre></table></code></div></div><p>To this:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>   <span class="na">volumes</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">hostPath</span><span class="pi">:</span>
       <span class="na">path</span><span class="pi">:</span> <span class="s">/var/new/etcd</span>
       <span class="na">type</span><span class="pi">:</span> <span class="s">DirectoryOrCreate</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-data</span>
    
</pre></table></code></div></div><li><p><strong>Wait for the Changes to Reflect</strong>:</p><p>After editing the static pod file, wait a few minutes for the changes to take effect. Your etcd will now be restored from the snapshot.</p></ol></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/wellcome/">Welcome to my blog!</a><li><a href="/posts/set-static-ip/">Static ip for Linux </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/networking/">networking</a></div></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> ¬© 2024 <a href="https://twitter.com/username">Alankar Nimgade</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/networking/">networking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/page.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
